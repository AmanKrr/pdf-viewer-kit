var __awaiter=this&&this.__awaiter||function(e,s,o,h){return new(o=o||Promise)(function(i,t){function a(e){try{r(h.next(e))}catch(e){t(e)}}function n(e){try{r(h.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,n)}r((h=h.apply(e,s||[])).next())})};import TextLayer from"./TextLayer";import PdfState from"./PdfState";import PageElement from"./PageElement";import{throttle}from"lodash";import ThumbnailViewer from"./ThumbnailViewer";import{PDFLinkService}from"../service/LinkService";import AnnotationLayer from"./AnnotationLayer";import{aPdfViewerIds}from"../../constant/ElementIdClass";import{AnnotationManager}from"../manager/AnnotationManager";class PageVirtualization{constructor(e,t,i,a,n,r,s=3){this.options=null,this.parentContainer=null,this.container=null,this.pageBuffer=3,this.renderedPages=new Set,this.lastScrollTop=0,this.pagePosition=new Map,this.debouncedScrollHandler=throttle(i=>__awaiter(this,void 0,void 0,function*(){var e,t;i||(e=(t=this.container.scrollTop)>this.lastScrollTop,this.lastScrollTop=t,t=this.calculatePageFromScroll(t),yield this.updateVisiblePages(e,t))}),160),this.options=e,this.totalPages=a,this.parentContainer=t,this.container=i.parentElement,this.pageBuffer=s,this.pdfState=PdfState.getInstance(e.containerId),this.pdf=this.pdfState.pdfInstance,this.pdfViewer=n,this.selectionManager=r,this.calculatePagePositioning().then(()=>__awaiter(this,void 0,void 0,function*(){null==this.isThereSpecificPageToRender||null==this.isThereSpecificPageToRender?(yield this.renderInitialPages(),this.attachScrollListener()):yield this.renderInitialPages(),yield this.generateThumbnail()}))}get isThereSpecificPageToRender(){var e;return null==(e=this.options)?void 0:e.renderSpecificPageOnly}get cachedPagePosition(){return this.pagePosition}attachScrollListener(){if(this.container){let e=!1;this.pdfState.on("scaleChange",()=>{e=!0,setTimeout(()=>e=!1,300)}),this.container.addEventListener("scroll",()=>this.debouncedScrollHandler(e))}}calculatePagesToFillViewport(){return __awaiter(this,void 0,void 0,function*(){if(!this.container)return 0;var t=this.container.getBoundingClientRect().height;let i=0,a=0;for(let e=1;e<=this.totalPages;e++){var n=yield this.pdf.getPage(e),r=this.pdfState.scale,n=n.getViewport({scale:r}).height;if(t<n){a++;break}if((i+=n)>=t){a++;break}a++}return a})}renderInitialPages(){return __awaiter(this,void 0,void 0,function*(){var e=this.isThereSpecificPageToRender;if(null!=e)this.renderedPages.add(e),yield this.renderPage(e);else{var t,i=yield this.calculatePagesToFillViewport(),a=[];for(let e=1;e<=i;e++)a.push(e),this.renderedPages.add(e);for(t of a)yield this.renderPage(t)}})}generateThumbnail(){return __awaiter(this,void 0,void 0,function*(){var t=this.isThereSpecificPageToRender,i=ThumbnailViewer.createThumbnailContainer(this.options.containerId),a=new PDFLinkService({pdfState:this.pdfState,pdfViewer:this.pdfViewer});for(let e=null!=t?t:1;e<=(null!=t?t:this.totalPages);e++){var n=new ThumbnailViewer({container:i,pageNumber:e,pdfDocument:this.pdf,linkService:a});yield n.initThumbnail(),e!==t&&e!==this.pdfState.currentPage||(n.activeThumbnail=this.pdfState.currentPage)}})}calculatePagePositioning(){return __awaiter(this,void 0,void 0,function*(){var t=this.pdfState.scale;let i=PageElement.gap,a=Number.NEGATIVE_INFINITY;var n=this.isThereSpecificPageToRender;for(let e=null!=n?n:1;e<=(null!=n?n:this.pdf.numPages);e++){var r=(yield this.pdf.getPage(e)).getViewport({scale:t});this.pagePosition.set(e,i),i+=r.height+PageElement.gap,a=Math.max(a,r.width)}return this.setContainerHeight(i+PageElement.gap),this.setContainerWidth(a+2*PageElement.gap),this.pagePosition})}setContainerHeight(e){var t;null!=(t=this.container)&&t.firstChild&&(this.container.firstChild.style.height=e+"px")}setContainerWidth(e){var t;null!=(t=this.container)&&t.firstChild&&(this.container.firstChild.style.width=e+"px")}calculatePageFromScroll(e){var t=Array.from(this.pagePosition.entries()).sort((e,t)=>e[1]-t[1]);let i=0,a=t.length-1;for(;i<=a;){var n=Math.floor((i+a)/2),[,r]=t[n];e<r?a=n-1:i=n+1}return t[Math.max(a,0)][0]}updateVisiblePages(e,i){return __awaiter(this,void 0,void 0,function*(){var e,t=this.getPagesInBuffer(i);for(e of t)this.renderedPages.has(e)||(yield this.renderPage(e),this.renderedPages.add(e));this.cleanupOutOfBufferPages(t)})}getPagesInBuffer(e){if(this.isThereSpecificPageToRender)return[];var t=Math.max(1,e-this.pageBuffer),i=Math.min(this.totalPages,e+this.pageBuffer),a=[];for(let e=t;e<=i;e++)a.push(e);return a}renderPage(s){return __awaiter(this,void 0,void 0,function*(){if(this.container){let i=yield this.pdf.getPage(s);var e=1<this.pdfState.scale?1:this.pdfState.scale;let a=i.getViewport({scale:e}),n=PageElement.createPageContainerDiv(s,a,this.pagePosition);n.style.backgroundColor="white",null!=(e=this.container.firstChild)&&e.appendChild(n);var[e,t]=PageElement.createCanvas(a),r=document.createElement("div"),e=(r.setAttribute("id","canva-presentation"),r.appendChild(e),n.appendChild(r),document.createElement("div")),r=(e.setAttribute("id","a-zoomed-page-image-container"),e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width=a.width+"px",e.style.height=a.height+"px",e.style.overflow="hidden",r.appendChild(e),{canvasContext:t,viewport:a,annotationMode:2});1<this.pdfState.scale&&this.updatePageBuffers(s),i.render(r).promise.then(()=>__awaiter(this,void 0,void 0,function*(){var e,t;this.options&&!this.options.disableTextSelection&&([e,t]=yield new TextLayer(n,i,a).createTextLayer(),yield new AnnotationLayer(n,i,a).createAnnotationLayer(this.pdfViewer,this.pdf),this.pdfViewer.annotation.isAnnotationManagerRegistered(s)||this.pdfViewer.annotation.registerAnnotationManager(s,new AnnotationManager(t,this.pdfState,this.selectionManager)),1<this.pdfState.scale)&&(yield this.appendHighResImageToPageContainer(s))}))}})}cleanupOutOfBufferPages(e){var t,i=Math.min(...e),a=Math.max(...e);for(t of this.renderedPages)(t<i||t>a)&&(this.pdfViewer.annotation.unregisterAnnotationManager(t),this.removePage(t),this.renderedPages.delete(t))}getViewport(e){return __awaiter(this,void 0,void 0,function*(){return(yield this.pdf.getPage(e)).getViewport({scale:this.pdfState.scale})})}removePage(e){var t=document.querySelector(`#${null==(t=this.options)?void 0:t.containerId} #pageContainer-`+e);t&&t.remove()}redrawVisiblePages(e){return __awaiter(this,void 0,void 0,function*(){var e=this.renderedPages;if(this.isThereSpecificPageToRender)yield this.renderPage(this.isThereSpecificPageToRender),yield this.appendHighResImageToPageContainer(this.isThereSpecificPageToRender);else for(var t of e)yield this.appendHighResImageToPageContainer(t)})}updatePageBuffers(){return __awaiter(this,arguments,void 0,function*(e=null){if(this.container)if(null!==e){var t,i,a=document.querySelector(`#${null==(a=this.options)?void 0:a.containerId} #pageContainer-`+e);a&&(t=yield this.pdf.getPage(e),i=this.pdfState.scale,t=t.getViewport({scale:i}),i=this.pagePosition.get(e)||0,a.style.top=i+"px",a.style.height=t.height+"px",a.style.width=t.width+"px",(e=a.querySelector("canvas"))&&(e.style.width=t.width+"px",e.style.height=t.height+"px"),(i=a.querySelector("#"+aPdfViewerIds._ANNOTATION_DRAWING_LAYER))&&(i.style.width=t.width+"px",i.style.height=t.height+"px"),a=null==e?void 0:e.nextElementSibling)&&(a.style.width=t.width+"px",a.style.height=t.height+"px",a.innerHTML="")}else{var n=document.querySelectorAll(`#${null==(i=this.options)?void 0:i.containerId} .a-page-view`);if(n)for(let t=0;t<n.length;t++){let e=parseInt(n[t].id.split("-")[1]);var r=yield this.pdf.getPage(e),s=this.pdfState.scale,r=r.getViewport({scale:s}),s=this.pagePosition.get(e)||0,s=(n[t].style.top=s+"px",n[t].style.height=r.height+"px",n[t].style.width=r.width+"px",n[t].querySelector("canvas")),o=(s&&(s.style.width=r.width+"px",s.style.height=r.height+"px"),n[t].querySelector("#"+aPdfViewerIds._ANNOTATION_DRAWING_LAYER)),o=(o&&(o.style.width=r.width+"px",o.style.height=r.height+"px"),null==s?void 0:s.nextElementSibling);o&&(o.style.width=r.width+"px",o.style.height=r.height+"px",o.innerHTML="")}}})}appendHighResImageToPageContainer(a){return __awaiter(this,void 0,void 0,function*(){var e=yield this.pdf.getPage(a),t=this.pdfState.scale,t=e.getViewport({scale:t}),i=document.createElement("img"),[t,,]=(i.style.width=t.width+"px",i.style.height=t.height+"px",yield this.renderHighResImage(t,e)),e=(i.src=t,document.querySelector(`#${this.pdfState.containerId} #pageContainer-`+a));e&&(t=e.querySelector("#canva-presentation"))&&(e=t.querySelector("#a-zoomed-page-image-container"))&&e.appendChild(i)})}renderHighResImage(i,a){return __awaiter(this,void 0,void 0,function*(){var[e,t]=PageElement.createCanvas(i);return yield a.render({canvasContext:t,viewport:i,annotationMode:2}).promise,[e.toDataURL("image/png"),e]})}}export default PageVirtualization;